<script setup lang="ts">
import { ref, onMounted, onUnmounted, nextTick } from 'vue';
import CommonButton from '~/components/ui/button/button.vue';

const props = defineProps<{
  text: string;
  tooltipId: string;
}>();

const slots = useSlots();
const referenceEl = ref<HTMLElement | null>(null);
const tooltipEl = ref<HTMLElement | null>(null);
const visible = ref(false);

function updatePosition() {
  const el = referenceEl.value;
  const tooltip = tooltipEl.value;
  if (!el || !tooltip) return;

  const rect = el.getBoundingClientRect();
  if (tooltip.offsetWidth === 0 || tooltip.offsetHeight === 0) {
    requestAnimationFrame(() => updatePosition());
    return;
  }

  const tooltipWidth = tooltip.offsetWidth;
  const tooltipHeight = tooltip.offsetHeight;
  const margin = 8;
  const windowWidth = window.innerWidth;

  let top = rect.top - tooltipHeight - margin;
  let left = rect.left + rect.width / 2 - tooltipWidth / 2;

  if (left < 8) left = 8;
  if (left + tooltipWidth > windowWidth - 8) {
    left = windowWidth - tooltipWidth - 8;
  }

  tooltip.style.top = `${top}px`;
  tooltip.style.left = `${left}px`;
}

function showTooltip() {
  visible.value = true;
  nextTick(() => {
    requestAnimationFrame(() => {
      updatePosition();
    });
  });
}

function hideTooltip() {
  visible.value = false;
}

onMounted(() => {
  window.addEventListener('resize', updatePosition);
  window.addEventListener('scroll', updatePosition, true);
});

onUnmounted(() => {
  window.removeEventListener('resize', updatePosition);
  window.removeEventListener('scroll', updatePosition, true);
});
</script>

<template>
  <div class="tooltip-wrapper">
    <div
      v-show="visible"
      ref="tooltipEl"
      :id="tooltipId"
      class="common-tooltip"
      role="tooltip"
      :aria-describedby="tooltipId"
    >
      <div class="tooltip-inner">
        {{ text }}
      </div>
      <span class="tooltip-arrow"></span>
    </div>

    <!-- 부모에서 넘긴 버튼 slot -->
    <button
      ref="referenceEl"
      @focus="visible = true"
      @blur="visible = false"
      @mouseenter="showTooltip"
      @mouseleave="hideTooltip"
    >
      <slot>버튼</slot>
    </button>
  </div>
</template>

<style scoped></style>
